<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Family Tree</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #ADD8E6; /* Changed to light blue */
    }
    
    .welcome-page {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }
    
    .tree-container {
      height: calc(100vh - 60px);
      overflow: hidden;
      position: relative;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    .form-page {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .profile-page {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .tree-toolbar {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 100;
      background-color: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .preview-image {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 5px;
    }
    
    .node {
      cursor: pointer;
    }
    
    .node-male {
      fill: #5D9CEC;
      stroke: #4A89DC;
      stroke-width: 2px;
    }
    
    .node-female {
      fill: #EC87C0;
      stroke: #D770AD;
      stroke-width: 2px;
    }
    
    .node-unknown {
      fill: #AAB2BD;
      stroke: #656D78;
      stroke-width: 2px;
    }
    
    .node-year-label {
      text-anchor: middle;
      font-size: 12px;
      font-weight: bold;
      fill: #00008B; /* Changed to dark blue */
      background-color: rgba(255, 255, 255, 0.7);
    }
    
    .delete-button {
      cursor: pointer;
      fill: #e74c3c;
      font-weight: bold;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .family-node:hover .delete-button {
      opacity: 1;
    }
    
    .tree-link {
      fill: none;
      stroke: #656D78;
      stroke-width: 2px;
    }
    
    .marriage-link {
      fill: none;
      stroke: #8e44ad;
      stroke-width: 2px;
    }
    
    .profile-header {
      display: flex;
      margin-bottom: 2rem;
    }
    
    .profile-picture {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 2rem;
    }
    
    .profile-info {
      flex: 1;
    }
    
    .relationship-title {
      margin-top: 2rem;
      font-weight: bold;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #ddd;
    }
    
    .relationship-item {
      margin: 1rem 0;
      padding: 0.5rem;
      background-color: #f8f9fa;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .relationship-item:hover {
      background-color: #e9ecef;
    }
    
    .family-node text {
      text-anchor: middle;
      dominant-baseline: middle;
      font-size: 12px;
      font-weight: bold;
      fill: #fff;
    }
    
    .family-node-label {
      text-anchor: middle;
      font-size: 12px;
      font-weight: bold;
      fill: #333;
    }
    
    .save-notice {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .save-notice.show {
      opacity: 1;
    }
    
    .person-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ffffff;
    }
    
    .add-member-floating {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #5D9CEC;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 100;
      font-size: 24px;
      cursor: pointer;
    }
    
    .relationship-section {
      margin-bottom: 20px;
      border: 1px solid #eee;
      border-radius: 5px;
      padding: 15px;
      background-color: #f9f9f9;
    }
    
    .relationship-section-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .tree-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #f8f9fa;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 90;
    }
    
    .tree-container.with-header {
      padding-top: 60px;
    }
  </style>
</head>
<body>
  <!-- Welcome Page -->
  <div id="welcome-page" class="page welcome-page active">
    <svg width="200" height="200" viewBox="0 0 200 200" class="mb-4">
      <style>
        .tree-trunk { fill: #8B4513; }
        .tree-leaves { fill: #228B22; }
      </style>
      <rect class="tree-trunk" x="95" y="140" width="10" height="40"/>
      <circle class="tree-leaves" cx="100" cy="90" r="60"/>
      <path class="tree-leaves" d="M100,140 C70,120 30,120 20,80 C10,40 70,20 100,40 C130,20 190,40 180,80 C170,120 130,120 100,140 Z"/>
    </svg>
    <h1 class="display-4 mb-4">Welcome to Your Family Tree</h1>
    <p class="lead mb-5">A simple way to create and view your family connections</p>
    
    <div id="storage-options" class="mb-4">
      <div class="d-flex flex-column gap-3">
        <button id="start-button" class="btn btn-primary btn-lg">
          <i class="fas fa-arrow-right me-2"></i>Start
        </button>
        <button id="import-button" class="btn btn-outline-primary">
          <i class="fas fa-file-import me-2"></i>Import Existing Data
        </button>
        <input type="file" id="import-file" accept=".json" class="d-none">
      </div>
    </div>
  </div>
  
  <!-- Add Member Form -->
  <div id="form-page" class="page form-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Add Family Member</h2>
      <button id="back-to-tree-from-form" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Tree
      </button>
    </div>
    
    <div id="success-alert" class="alert alert-success d-none" role="alert">
      Family member added successfully!
    </div>
    
    <form id="member-form">
      <div class="card mb-4">
        <div class="card-header">Personal Information</div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="firstName">
            </div>
            <div class="col-md-4">
              <label for="middleName" class="form-label">Middle Name</label>
              <input type="text" class="form-control" id="middleName">
            </div>
            <div class="col-md-4">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="lastName">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="gender" class="form-label">Gender</label>
              <select class="form-select" id="gender">
                <option value="" selected>Select gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">Date of Birth</label>
              <div class="row g-2">
                <div class="col-md-4">
                  <select class="form-select" id="birthMonth">
                    <option value="" selected>Month</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <select class="form-select" id="birthDay">
                    <option value="" selected>Day</option>
                    <!-- Will be populated by JavaScript -->
                  </select>
                </div>
                <div class="col-md-4">
                  <input type="number" class="form-control" id="birthYear" placeholder="Year">
                </div>
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-12">
              <label class="form-label">Date of Death (if applicable)</label>
              <div class="row g-2">
                <div class="col-md-4">
                  <select class="form-select" id="deathMonth">
                    <option value="" selected>Month</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <select class="form-select" id="deathDay">
                    <option value="" selected>Day</option>
                    <!-- Will be populated by JavaScript -->
                  </select>
                </div>
                <div class="col-md-4">
                  <input type="number" class="form-control" id="deathYear" placeholder="Year">
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Photo</label>
            <input type="file" class="form-control" id="photoInput" accept="image/*">
            <div class="mt-2" id="photoPreviewContainer">
              <img id="photoPreview" class="preview-image d-none">
            </div>
          </div>
          
          <div class="mb-3">
            <label for="birthplace" class="form-label">Birthplace</label>
            <input type="text" class="form-control" id="birthplace">
          </div>
          
          <div class="mb-3">
            <label for="occupation" class="form-label">Occupation</label>
            <input type="text" class="form-control" id="occupation">
          </div>
          
          <div class="mb-3">
            <label for="notes" class="form-label">Notes</label>
            <textarea class="form-control" id="notes" rows="3"></textarea>
          </div>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header">Family Relationships</div>
        <div class="card-body">
          <!-- Parents Section -->
          <div class="relationship-section">
            <div class="relationship-section-title">Parents</div>
            <div class="mb-3">
              <label for="parentSelect" class="form-label">Add Parent</label>
              <div class="input-group">
                <select class="form-select" id="parentSelect">
                  <option value="" selected>Select parent</option>
                  <!-- Will be populated by JavaScript -->
                </select>
                <select class="form-select" id="parentRelationship">
                  <option value="biological">Biological</option>
                  <option value="adoptive">Adoptive</option>
                  <option value="step">Step</option>
                  <option value="foster">Foster</option>
                </select>
                <button class="btn btn-outline-primary" type="button" id="addParentBtn">Add</button>
              </div>
              <div id="parentsList" class="mt-2">
                <!-- Parents will be listed here -->
              </div>
            </div>
          </div>
          
          <!-- Spouses Section -->
          <div class="relationship-section">
            <div class="relationship-section-title">Partners/Spouses</div>
            <div class="mb-3">
              <label for="spouseSelect" class="form-label">Add Spouse/Partner</label>
              <div class="input-group">
                <select class="form-select" id="spouseSelect">
                  <option value="" selected>Select spouse/partner</option>
                  <!-- Will be populated by JavaScript -->
                </select>
                <select class="form-select" id="relationshipType">
                  <option value="married">Married</option>
                  <option value="divorced">Divorced</option>
                  <option value="partner">Partner</option>
                  <option value="separated">Separated</option>
                </select>
                <button class="btn btn-outline-primary" type="button" id="addSpouseBtn">Add</button>
              </div>
              <div id="spousesList" class="mt-2">
                <!-- Spouses will be listed here -->
              </div>
            </div>
          </div>
          
          <!-- Siblings Section -->
          <div class="relationship-section">
            <div class="relationship-section-title">Siblings</div>
            <div class="mb-3">
              <label for="siblingSelect" class="form-label">Add Sibling</label>
              <div class="input-group">
                <select class="form-select" id="siblingSelect">
                  <option value="" selected>Select sibling</option>
                  <!-- Will be populated by JavaScript -->
                </select>
                <select class="form-select" id="siblingRelationship">
                  <option value="full">Full Sibling</option>
                  <option value="half">Half Sibling</option>
                  <option value="step">Step Sibling</option>
                  <option value="adoptive">Adoptive Sibling</option>
                </select>
                <button class="btn btn-outline-primary" type="button" id="addSiblingBtn">Add</button>
              </div>
              <div id="siblingsList" class="mt-2">
                <!-- Siblings will be listed here -->
              </div>
            </div>
          </div>
          
          <!-- Children Section -->
          <div class="relationship-section">
            <div class="relationship-section-title">Children</div>
            <div class="mb-3">
              <label for="childSelect" class="form-label">Add Child</label>
              <div class="input-group">
                <select class="form-select" id="childSelect">
                  <option value="" selected>Select child</option>
                  <!-- Will be populated by JavaScript -->
                </select>
                <select class="form-select" id="childRelationship">
                  <option value="biological">Biological</option>
                  <option value="adoptive">Adoptive</option>
                  <option value="step">Step</option>
                  <option value="foster">Foster</option>
                </select>
                <button class="btn btn-outline-primary" type="button" id="addChildBtn">Add</button>
              </div>
              <div id="childrenList" class="mt-2">
                <!-- Children will be listed here -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="d-flex justify-content-between">
        <button type="button" id="cancel-button" class="btn btn-outline-secondary">Cancel</button>
        <div>
          <button type="button" id="reset-button" class="btn btn-outline-secondary me-2">Reset</button>
          <button type="button" id="save-button" class="btn btn-primary">Save Family Member</button>
        </div>
      </div>
    </form>
  </div>
  
  <!-- Tree View -->
  <div id="tree-page" class="page">
    <div class="tree-header">
      <h3>Family Tree</h3>
      <div class="d-flex gap-2">
        <button id="add-member-button" class="btn btn-primary">
          <i class="fas fa-plus me-2"></i>Add Member
        </button>
        <button id="export-button" class="btn btn-outline-primary">
          <i class="fas fa-download me-2"></i>Export
        </button>
        <button id="organize-tree-button" class="btn btn-outline-secondary">
          <i class="fas fa-sitemap me-2"></i>Organize Tree
        </button>
      </div>
    </div>
    
    <div class="tree-toolbar">
      <button id="zoom-in-button" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-search-plus"></i>
      </button>
      <button id="zoom-out-button" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-search-minus"></i>
      </button>
      <button id="center-tree-button" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-compress-arrows-alt"></i>
      </button>
    </div>
    
    <div id="tree-container" class="tree-container with-header">
      <!-- Tree will be rendered here -->
    </div>
    
    <div class="add-member-floating" id="add-member-floating">
      <i class="fas fa-plus"></i>
    </div>
    
    <div id="relationship-finder" class="card position-fixed bottom-0 start-0 end-0 mb-0" style="z-index: 1000; display: none;">
      <div class="card-header d-flex justify-content-between align-items-center bg-light">
        <h5 class="mb-0">Find Relationship</h5>
        <button type="button" class="btn-close" id="close-relationship-finder"></button>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-5">
            <label for="person1Select" class="form-label">First Person</label>
            <select class="form-select" id="person1Select">
              <option value="" selected>Select person</option>
            </select>
          </div>
          <div class="col-md-5">
            <label for="person2Select" class="form-label">Second Person</label>
            <select class="form-select" id="person2Select">
              <option value="" selected>Select person</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button id="find-relationship-btn" class="btn btn-primary w-100">Find Relationship</button>
          </div>
        </div>
        <div id="relationship-result" class="mt-3">
          <!-- Relationship results will be displayed here -->
        </div>
      </div>
    </div>
    
    <div class="position-fixed bottom-0 end-0 mb-3 me-3" style="z-index: 1000;">
      <button id="toggle-relationship-finder" class="btn btn-primary me-2">
        <i class="fas fa-people-arrows me-2"></i>Find Relationship
      </button>
    </div>
    
    <div id="save-notice" class="save-notice">Data saved to localStorage</div>
  </div>
  
  <!-- Profile View -->
  <div id="profile-page" class="page profile-page">
    <div id="profile-container">
      <!-- Will be populated by JavaScript -->
    </div>
    
    <div class="mt-4">
      <button id="back-to-tree-button" class="btn btn-outline-secondary">Back to Tree</button>
      <button id="edit-profile-button" class="btn btn-primary float-end">Edit</button>
    </div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script>
    // Main application
    const familyTreeApp = {
      // Data
      members: [],
      relationships: [],
      currentMember: null,
      zoomLevel: 1,
      
      // Pages
      pages: {
        welcome: document.getElementById('welcome-page'),
        form: document.getElementById('form-page'),
        tree: document.getElementById('tree-page'),
        profile: document.getElementById('profile-page')
      },
      
      // Initialize the application
      init: function() {
        this.loadData();
        this.setupEventListeners();
        this.setupDaySelectors();
        this.populateMemberSelectors();
        
        if (this.members.length > 0) {
          this.showPage('tree');
          this.renderTree();
        }
      },
      
      // Setup day selectors based on month
      setupDaySelectors: function() {
        const populateDays = (monthSelector, daySelector) => {
          monthSelector.addEventListener('change', () => {
            const month = parseInt(monthSelector.value);
            const daySelect = document.getElementById(daySelector);
            
            // Clear days
            while (daySelect.options.length > 1) {
              daySelect.remove(1);
            }
            
            if (!month) return;
            
            // Define days in month
            let daysInMonth;
            if ([4, 6, 9, 11].includes(month)) {
              daysInMonth = 30;
            } else if (month === 2) {
              daysInMonth = 29; // We'll just use 29 for February to be safe
            } else {
              daysInMonth = 31;
            }
            
            // Add day options
            for (let i = 1; i <= daysInMonth; i++) {
              const option = document.createElement('option');
              option.value = i;
              option.textContent = i;
              daySelect.appendChild(option);
            }
          });
        };
        
        // Setup for birth date
        const birthMonth = document.getElementById('birthMonth');
        if (birthMonth) {
          populateDays(birthMonth, 'birthDay');
        }
        
        // Setup for death date
        const deathMonth = document.getElementById('deathMonth');
        if (deathMonth) {
          populateDays(deathMonth, 'deathDay');
        }
      },
      
      // Load data from localStorage
      loadData: function() {
        try {
          const membersData = localStorage.getItem('familyTreeMembers');
          const relationshipsData = localStorage.getItem('familyTreeRelationships');
          
          if (membersData) {
            this.members = JSON.parse(membersData);
          }
          
          if (relationshipsData) {
            this.relationships = JSON.parse(relationshipsData);
          }
        } catch (error) {
          console.error('Error loading data from localStorage:', error);
          this.members = [];
          this.relationships = [];
        }
      },
      
      // Save data to localStorage
      saveData: function() {
        try {
          localStorage.setItem('familyTreeMembers', JSON.stringify(this.members));
          localStorage.setItem('familyTreeRelationships', JSON.stringify(this.relationships));
          
          const saveNotice = document.getElementById('save-notice');
          saveNotice.classList.add('show');
          setTimeout(() => {
            saveNotice.classList.remove('show');
          }, 2000);
          
          return true;
        } catch (error) {
          console.error('Error saving data to localStorage:', error);
          alert('Could not save data to localStorage.');
          return false;
        }
      },
      
      // Export data as file
      exportData: function() {
        const data = {
          members: this.members,
          relationships: this.relationships,
          exportDate: new Date().toISOString()
        };
        
        const jsonData = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `family_tree_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },
      
      // Import data from file
      importData: function(jsonData) {
        try {
          const data = JSON.parse(jsonData);
          if (data.members && Array.isArray(data.members) && 
              data.relationships && Array.isArray(data.relationships)) {
            this.members = data.members;
            this.relationships = data.relationships;
            this.saveData();
            this.populateMemberSelectors();
            this.renderTree();
            return true;
          }
        } catch (error) {
          console.error('Error importing data:', error);
        }
        return false;
      },
      
      // Setup event listeners
      setupEventListeners: function() {
        document.getElementById('start-button').addEventListener('click', () => {
          this.showPage('form');
        });
        
        document.getElementById('import-button').addEventListener('click', () => {
          document.getElementById('import-file').click();
        });
        
        document.getElementById('import-file').addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = (event) => {
              if (this.importData(event.target.result)) {
                alert('Data imported successfully!');
                this.showPage('tree');
              } else {
                alert('Error importing data.');
              }
            };
            
            reader.readAsText(file);
          }
        });
        
        document.getElementById('back-to-tree-from-form').addEventListener('click', () => {
          this.showPage(this.members.length > 0 ? 'tree' : 'welcome');
        });
        
        document.getElementById('cancel-button').addEventListener('click', () => {
          this.showPage(this.members.length > 0 ? 'tree' : 'welcome');
        });
        
        document.getElementById('reset-button').addEventListener('click', () => {
          this.resetForm();
        });
        
        document.getElementById('save-button').addEventListener('click', () => {
          this.saveMember();
        });
        
        document.getElementById('toggle-relationship-finder').addEventListener('click', () => {
          const finderPanel = document.getElementById('relationship-finder');
          finderPanel.style.display = finderPanel.style.display === 'none' ? 'block' : 'none';
          if (finderPanel.style.display === 'block') {
            this.populateRelationshipFinderSelects();
          }
        });
        
        document.getElementById('close-relationship-finder').addEventListener('click', () => {
          document.getElementById('relationship-finder').style.display = 'none';
        });
        
        document.getElementById('find-relationship-btn').addEventListener('click', () => {
          this.findRelationship();
        });
        
        document.getElementById('photoInput').addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const photoPreview = document.getElementById('photoPreview');
              photoPreview.src = event.target.result;
              photoPreview.classList.remove('d-none');
            };
            reader.readAsDataURL(e.target.files[0]);
          }
        });
        
        document.getElementById('addParentBtn').addEventListener('click', () => {
          const parentSelect = document.getElementById('parentSelect');
          const relationshipType = document.getElementById('parentRelationship').value;
          if (parentSelect.value) {
            const parent = this.members.find(m => m.id === parentSelect.value);
            if (parent) {
              this.addRelationshipToForm('parent', parent, relationshipType);
              parentSelect.value = '';
            }
          }
        });
        
        document.getElementById('addSpouseBtn').addEventListener('click', () => {
          const spouseSelect = document.getElementById('spouseSelect');
          const relationshipType = document.getElementById('relationshipType').value;
          if (spouseSelect.value) {
            const spouse = this.members.find(m => m.id === spouseSelect.value);
            if (spouse) {
              this.addRelationshipToForm('spouse', spouse, relationshipType);
              spouseSelect.value = '';
            }
          }
        });
        
        document.getElementById('addSiblingBtn').addEventListener('click', () => {
          const siblingSelect = document.getElementById('siblingSelect');
          const relationshipType = document.getElementById('siblingRelationship').value;
          if (siblingSelect.value) {
            const sibling = this.members.find(m => m.id === siblingSelect.value);
            if (sibling) {
              this.addRelationshipToForm('sibling', sibling, relationshipType);
              siblingSelect.value = '';
            }
          }
        });
        
        document.getElementById('addChildBtn').addEventListener('click', () => {
          const childSelect = document.getElementById('childSelect');
          const relationshipType = document.getElementById('childRelationship').value;
          if (childSelect.value) {
            const child = this.members.find(m => m.id === childSelect.value);
            if (child) {
              this.addRelationshipToForm('child', child, relationshipType);
              childSelect.value = '';
            }
          }
        });
        
        document.getElementById('add-member-button').addEventListener('click', () => {
          this.resetForm();
          this.showPage('form');
        });
        
        document.getElementById('add-member-floating').addEventListener('click', () => {
          this.resetForm();
          this.showPage('form');
        });
        
        document.getElementById('export-button').addEventListener('click', () => {
          this.exportData();
        });
        
        document.getElementById('organize-tree-button').addEventListener('click', () => {
          this.renderTree(true);
        });
        
        document.getElementById('zoom-in-button').addEventListener('click', () => {
          this.zoomTree(0.2);
        });
        
        document.getElementById('zoom-out-button').addEventListener('click', () => {
          this.zoomTree(-0.2);
        });
        
        document.getElementById('center-tree-button').addEventListener('click', () => {
          this.centerTree();
        });
        
        document.getElementById('back-to-tree-button').addEventListener('click', () => {
          this.showPage('tree');
        });
        
        document.getElementById('edit-profile-button').addEventListener('click', () => {
          if (this.currentMember) {
            this.populateFormForEdit(this.currentMember);
            this.showPage('form');
          }
        });
      },
      
      // Show a specific page
      showPage: function(pageName) {
        Object.values(this.pages).forEach(page => page.classList.remove('active'));
        if (this.pages[pageName]) {
          this.pages[pageName].classList.add('active');
          if (pageName === 'tree') this.renderTree();
        }
      },
      
      // Reset the form
      resetForm: function() {
        document.getElementById('member-form').reset();
        document.getElementById('photoPreview').classList.add('d-none');
        document.getElementById('parentsList').innerHTML = '';
        document.getElementById('spousesList').innerHTML = '';
        document.getElementById('siblingsList').innerHTML = '';
        document.getElementById('childrenList').innerHTML = '';
        document.getElementById('save-button').textContent = 'Save Family Member';
        document.getElementById('save-button').dataset.editing = '';
      },
      
      // Save a new member or update existing
      saveMember: function() {
        const firstName = document.getElementById('firstName').value.trim();
        const middleName = document.getElementById('middleName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const gender = document.getElementById('gender').value;
        
        const birthMonth = document.getElementById('birthMonth').value;
        const birthDay = document.getElementById('birthDay').value;
        const birthYear = document.getElementById('birthYear').value;
        
        const deathMonth = document.getElementById('deathMonth').value;
        const deathDay = document.getElementById('deathDay').value;
        const deathYear = document.getElementById('deathYear').value;
        
        const birthplace = document.getElementById('birthplace').value.trim();
        const occupation = document.getElementById('occupation').value.trim();
        const notes = document.getElementById('notes').value.trim();
        
        const photoPreview = document.getElementById('photoPreview');
        const photo = photoPreview.classList.contains('d-none') ? '' : photoPreview.src;
        
        const member = {
          firstName,
          middleName,
          lastName,
          gender,
          birthMonth,
          birthDay,
          birthYear,
          deathMonth,
          deathDay,
          deathYear,
          birthplace,
          occupation,
          notes,
          photo
        };
        
        const parentItems = Array.from(document.querySelectorAll('#parentsList [data-id]'));
        const parentRelationships = parentItems.map(el => ({
          id: el.dataset.id,
          type: el.dataset.relationshipType || 'biological'
        }));
        
        const spouseItems = Array.from(document.querySelectorAll('#spousesList [data-id]'));
        const spouseRelationships = spouseItems.map(el => ({
          id: el.dataset.id,
          type: el.dataset.relationshipType || 'married'
        }));
        
        const siblingItems = Array.from(document.querySelectorAll('#siblingsList [data-id]'));
        const siblingRelationships = siblingItems.map(el => ({
          id: el.dataset.id,
          type: el.dataset.relationshipType || 'full'
        }));
        
        const childItems = Array.from(document.querySelectorAll('#childrenList [data-id]'));
        const childRelationships = childItems.map(el => ({
          id: el.dataset.id,
          type: el.dataset.relationshipType || 'biological'
        }));
        
        const editingId = document.getElementById('save-button').dataset.editing;
        
        if (editingId) {
          member.id = editingId;
          this.updateMember(member);
          this.relationships = this.relationships.filter(r =>
            !(r.from === editingId && (r.type === 'parent' || r.type === 'child' || r.type === 'sibling')) &&
            !(r.to === editingId && (r.type === 'parent' || r.type === 'child' || r.type === 'sibling')) &&
            !((r.from === editingId || r.to === editingId) && r.type === 'spouse')
          );
        } else {
          member.id = this.generateUniqueId();
          this.members.push(member);
        }
        
        parentRelationships.forEach(rel => {
          this.relationships.push({
            from: rel.id,
            to: member.id,
            type: 'parent',
            relationshipType: rel.type
          });
        });
        
        spouseRelationships.forEach(rel => {
          this.relationships.push({
            from: member.id,
            to: rel.id,
            type: 'spouse',
            relationshipType: rel.type
          });
        });
        
        siblingRelationships.forEach(rel => {
          this.relationships.push({
            from: member.id,
            to: rel.id,
            type: 'sibling',
            relationshipType: rel.type
          });
        });
        
        childRelationships.forEach(rel => {
          this.relationships.push({
            from: member.id,
            to: rel.id,
            type: 'parent',
            relationshipType: rel.type
          });
        });
        
        this.saveData();
        const successAlert = document.getElementById('success-alert');
        successAlert.classList.remove('d-none');
        successAlert.textContent = editingId ? 'Family member updated successfully!' : 'Family member added successfully!';
        setTimeout(() => { successAlert.classList.add('d-none'); }, 3000);
        this.populateMemberSelectors();
        this.resetForm();
        this.showPage('tree');
      },
      
      // Format date string for display
      formatDateString: function(month, day, year) {
        let parts = [];
        if (month) {
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          parts.push(monthNames[parseInt(month) - 1]);
        }
        if (day) parts.push(day);
        if (year) parts.push(year);
        return parts.join(' ');
      },
      
      // Update an existing member
      updateMember: function(member) {
        const index = this.members.findIndex(m => m.id === member.id);
        if (index !== -1) {
          this.members[index] = member;
          this.saveData();
        }
      },
      
      // Add relationship to the form
      addRelationshipToForm: function(type, person, relationshipType) {
        let listElement;
        switch(type) {
          case 'parent':
            listElement = document.getElementById('parentsList');
            break;
          case 'spouse':
            listElement = document.getElementById('spousesList');
            break;
          case 'sibling':
            listElement = document.getElementById('siblingsList');
            break;
          case 'child':
            listElement = document.getElementById('childrenList');
            break;
          default:
            return;
        }
        if (listElement.querySelector(`[data-id="${person.id}"]`)) {
          return;
        }
        const item = document.createElement('div');
        item.className = 'alert alert-secondary d-flex justify-content-between align-items-center';
        item.dataset.id = person.id;
        item.dataset.relationshipType = relationshipType;
        let relationshipDisplay = relationshipType ? relationshipType.charAt(0).toUpperCase() + relationshipType.slice(1) : '';
        item.innerHTML = `
          <div>
            <strong>${this.getDisplayName(person)}</strong>
            ${relationshipDisplay ? `<span class="badge bg-info ms-2">${relationshipDisplay}</span>` : ''}
          </div>
          <button type="button" class="btn-close"></button>
        `;
        listElement.appendChild(item);
        item.querySelector('.btn-close').addEventListener('click', () => { item.remove(); });
      },
      
      // Populate member selectors for relationships
      populateMemberSelectors: function() {
        const selectors = {
          parent: document.getElementById('parentSelect'),
          spouse: document.getElementById('spouseSelect'),
          sibling: document.getElementById('siblingSelect'),
          child: document.getElementById('childSelect')
        };
        Object.values(selectors).forEach(selector => {
          if (!selector) return;
          while (selector.options.length > 1) selector.remove(1);
        });
        this.members.forEach(member => {
          const option = document.createElement('option');
          option.value = member.id;
          option.textContent = this.getDisplayName(member);
          Object.values(selectors).forEach(selector => {
            if (selector) selector.appendChild(option.cloneNode(true));
          });
        });
      },
      
      // Populate form for editing
      populateFormForEdit: function(member) {
        document.getElementById('firstName').value = member.firstName || '';
        document.getElementById('middleName').value = member.middleName || '';
        document.getElementById('lastName').value = member.lastName || '';
        document.getElementById('gender').value = member.gender || '';
        document.getElementById('birthMonth').value = member.birthMonth || '';
        if (member.birthMonth) {
          const event = new Event('change');
          document.getElementById('birthMonth').dispatchEvent(event);
          setTimeout(() => { document.getElementById('birthDay').value = member.birthDay || ''; }, 100);
        }
        document.getElementById('birthYear').value = member.birthYear || '';
        document.getElementById('deathMonth').value = member.deathMonth || '';
        if (member.deathMonth) {
          const event = new Event('change');
          document.getElementById('deathMonth').dispatchEvent(event);
          setTimeout(() => { document.getElementById('deathDay').value = member.deathDay || ''; }, 100);
        }
        document.getElementById('deathYear').value = member.deathYear || '';
        document.getElementById('birthplace').value = member.birthplace || '';
        document.getElementById('occupation').value = member.occupation || '';
        document.getElementById('notes').value = member.notes || '';
        const photoPreview = document.getElementById('photoPreview');
        if (member.photo) {
          photoPreview.src = member.photo;
          photoPreview.classList.remove('d-none');
        } else {
          photoPreview.classList.add('d-none');
        }
        document.getElementById('parentsList').innerHTML = '';
        document.getElementById('spousesList').innerHTML = '';
        document.getElementById('siblingsList').innerHTML = '';
        document.getElementById('childrenList').innerHTML = '';
        this.relationships
          .filter(r => r.to === member.id && r.type === 'parent')
          .forEach(r => {
            const parent = this.members.find(m => m.id === r.from);
            if (parent) {
              this.addRelationshipToForm('parent', parent, r.relationshipType);
            }
          });
        this.relationships
          .filter(r => (r.from === member.id || r.to === member.id) && r.type === 'spouse')
          .forEach(r => {
            const spouseId = r.from === member.id ? r.to : r.from;
            const spouse = this.members.find(m => m.id === spouseId);
            if (spouse) {
              this.addRelationshipToForm('spouse', spouse, r.relationshipType);
            }
          });
        this.relationships
          .filter(r => ((r.from === member.id && r.to !== member.id) || 
                        (r.to === member.id && r.from !== member.id)) && r.type === 'sibling')
          .forEach(r => {
            const siblingId = r.from === member.id ? r.to : r.from;
            const sibling = this.members.find(m => m.id === siblingId);
            if (sibling) {
              this.addRelationshipToForm('sibling', sibling, r.relationshipType);
            }
          });
        this.relationships
          .filter(r => r.from === member.id && r.type === 'parent')
          .forEach(r => {
            const child = this.members.find(m => m.id === r.to);
            if (child) {
              this.addRelationshipToForm('child', child, r.relationshipType);
            }
          });
        document.getElementById('save-button').textContent = 'Update Family Member';
        document.getElementById('save-button').dataset.editing = member.id;
      },
      
      // Show profile page
      showProfile: function(member) {
        this.currentMember = member;
        const container = document.getElementById('profile-container');
        const parents = this.getParents(member.id);
        const spouses = this.getSpouses(member.id);
        const siblings = this.getSiblings(member.id);
        const children = this.getChildren(member.id);
        
        let html = `
          <div class="profile-header">
            ${member.photo 
              ? `<img src="${member.photo}" class="profile-picture" alt="Profile photo">`
              : `<div class="profile-picture d-flex align-items-center justify-content-center bg-light">
                  <i class="fas fa-user fa-4x text-secondary"></i>
                </div>`
            }
            <div class="profile-info">
              <h1>${this.getDisplayName(member)}</h1>
              ${member.gender ? `<p><strong>Gender:</strong> ${this.capitalizeFirst(member.gender)}</p>` : ''}
              ${member.birthYear ? `<p><strong>Birth Year:</strong> ${member.birthYear}${member.deathYear ? ` - Death Year: ${member.deathYear}` : ''}</p>` : ''}
              ${member.birthplace ? `<p><strong>Birthplace:</strong> ${member.birthplace}</p>` : ''}
              ${member.occupation ? `<p><strong>Occupation:</strong> ${member.occupation}</p>` : ''}
            </div>
          </div>
          ${member.notes ? `
          <div class="card mb-4">
            <div class="card-header">Notes</div>
            <div class="card-body">
              <p>${member.notes}</p>
            </div>
          </div>` : ''}
        `;
        
        if (parents.length > 0) {
          html += `<h3 class="relationship-title">Parents</h3>`;
          parents.forEach(parent => {
            const relationshipType = this.getRelationshipType('parent', parent.id, member.id);
            html += `
              <div class="relationship-item" data-id="${parent.id}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    ${parent.photo ? `<img src="${parent.photo}" class="me-2" width="30" height="30" style="border-radius: 50%; object-fit: cover;">` : ''}
                    ${this.getDisplayName(parent)}
                  </div>
                  ${relationshipType ? `<span class="badge bg-info">${this.capitalizeFirst(relationshipType)}</span>` : ''}
                </div>
              </div>
            `;
          });
        }
        
        if (spouses.length > 0) {
          html += `<h3 class="relationship-title">Spouses/Partners</h3>`;
          spouses.forEach(spouse => {
            const relationshipType = this.getRelationshipType('spouse', member.id, spouse.id);
            html += `
              <div class="relationship-item" data-id="${spouse.id}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    ${spouse.photo ? `<img src="${spouse.photo}" class="me-2" width="30" height="30" style="border-radius: 50%; object-fit: cover;">` : ''}
                    ${this.getDisplayName(spouse)}
                  </div>
                  ${relationshipType ? `<span class="badge bg-info">${this.capitalizeFirst(relationshipType)}</span>` : ''}
                </div>
              </div>
            `;
          });
        }
        
        if (siblings.length > 0) {
          html += `<h3 class="relationship-title">Siblings</h3>`;
          siblings.forEach(sibling => {
            const relationshipType = this.getRelationshipType('sibling', member.id, sibling.id);
            html += `
              <div class="relationship-item" data-id="${sibling.id}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    ${sibling.photo ? `<img src="${sibling.photo}" class="me-2" width="30" height="30" style="border-radius: 50%; object-fit: cover;">` : ''}
                    ${this.getDisplayName(sibling)}
                  </div>
                  ${relationshipType ? `<span class="badge bg-info">${this.capitalizeFirst(relationshipType)}</span>` : ''}
                </div>
              </div>
            `;
          });
        }
        
        if (children.length > 0) {
          html += `<h3 class="relationship-title">Children</h3>`;
          children.forEach(child => {
            const relationshipType = this.getRelationshipType('parent', member.id, child.id);
            html += `
              <div class="relationship-item" data-id="${child.id}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    ${child.photo ? `<img src="${child.photo}" class="me-2" width="30" height="30" style="border-radius: 50%; object-fit: cover;">` : ''}
                    ${this.getDisplayName(child)}
                  </div>
                  ${relationshipType ? `<span class="badge bg-info">${this.capitalizeFirst(relationshipType)}</span>` : ''}
                </div>
              </div>
            `;
          });
        }
        
        container.innerHTML = html;
        container.querySelectorAll('.relationship-item').forEach(item => {
          item.addEventListener('click', () => {
            const id = item.dataset.id;
            const person = this.members.find(m => m.id === id);
            if (person) {
              this.showProfile(person);
            }
          });
        });
        
        this.showPage('profile');
      },
      
      // Get relationship type between two people
      getRelationshipType: function(baseType, fromId, toId) {
        const relationship = this.relationships.find(r => 
          (r.type === baseType && r.from === fromId && r.to === toId) ||
          (r.type === baseType && r.from === toId && r.to === fromId && (baseType === 'spouse' || baseType === 'sibling'))
        );
        return relationship ? relationship.relationshipType : null;
      },
      
      // Get parents of a person
      getParents: function(personId) {
        return this.relationships
          .filter(r => r.to === personId && r.type === 'parent')
          .map(r => this.members.find(m => m.id === r.from))
          .filter(Boolean);
      },
      
      // Get spouses of a person
      getSpouses: function(personId) {
        return this.relationships
          .filter(r => (r.from === personId || r.to === personId) && r.type === 'spouse')
          .map(r => {
            const spouseId = r.from === personId ? r.to : r.from;
            return this.members.find(m => m.id === spouseId);
          })
          .filter(Boolean);
      },
      
      // Get siblings of a person
      getSiblings: function(personId) {
        const directSiblings = this.relationships
          .filter(r => (r.from === personId || r.to === personId) && r.type === 'sibling')
          .map(r => {
            const siblingId = r.from === personId ? r.to : r.from;
            return this.members.find(m => m.id === siblingId);
          })
          .filter(Boolean);
        const parents = this.getParents(personId);
        let parentSiblings = [];
        if (parents.length > 0) {
          const siblingIds = new Set();
          parents.forEach(parent => {
            const children = this.getChildren(parent.id);
            children.forEach(child => {
              if (child.id !== personId) {
                siblingIds.add(child.id);
              }
            });
          });
          parentSiblings = Array.from(siblingIds)
            .map(id => this.members.find(m => m.id === id))
            .filter(Boolean);
        }
        const allSiblings = [...directSiblings, ...parentSiblings];
        return Array.from(new Map(allSiblings.map(s => [s.id, s])).values());
      },
      
      // Get children of a person
      getChildren: function(personId) {
        return this.relationships
          .filter(r => r.from === personId && r.type === 'parent')
          .map(r => this.members.find(m => m.id === r.to))
          .filter(Boolean);
      },
      
      // Zoom the tree
      zoomTree: function(zoomDelta) {
        const svg = d3.select('#tree-container svg');
        if (!svg.empty()) {
          const zoom = d3.zoom();
          let transform = d3.zoomTransform(svg.node());
          this.zoomLevel = Math.max(0.1, Math.min(3, this.zoomLevel + zoomDelta));
          svg.call(zoom.transform, transform.scale(this.zoomLevel / transform.k));
        }
      },
      
      // Center the tree
      centerTree: function() {
        const svg = d3.select('#tree-container svg');
        const container = document.getElementById('tree-container');
        if (!svg.empty() && container) {
          const zoom = d3.zoom();
          const g = svg.select('g');
          if (!g.empty()) {
            const bounds = g.node().getBBox();
            const width = container.clientWidth;
            const height = container.clientHeight;
            const centerX = bounds.x + bounds.width / 2;
            const centerY = bounds.y + bounds.height / 2;
            const scale = 0.9 / Math.max(bounds.width / width, bounds.height / height);
            const translate = [width / 2 - scale * centerX, height / 2 - scale * centerY];
            this.zoomLevel = scale;
            svg.call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
          }
        }
      },
      
      // Populate relationship finder selects
      populateRelationshipFinderSelects: function() {
        const person1Select = document.getElementById('person1Select');
        const person2Select = document.getElementById('person2Select');
        while (person1Select.options.length > 1) person1Select.remove(1);
        while (person2Select.options.length > 1) person2Select.remove(1);
        this.members.forEach(member => {
          const option1 = document.createElement('option');
          option1.value = member.id;
          option1.textContent = this.getDisplayName(member);
          person1Select.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = member.id;
          option2.textContent = this.getDisplayName(member);
          person2Select.appendChild(option2);
        });
      },
      
      // Find relationship between two people
      findRelationship: function() {
        const person1Id = document.getElementById('person1Select').value;
        const person2Id = document.getElementById('person2Select').value;
        const resultContainer = document.getElementById('relationship-result');
        if (!person1Id || !person2Id) {
          resultContainer.innerHTML = '<div class="alert alert-warning">Please select two people</div>';
          return;
        }
        if (person1Id === person2Id) {
          resultContainer.innerHTML = '<div class="alert alert-info">Same person selected</div>';
          return;
        }
        const person1 = this.members.find(m => m.id === person1Id);
        const person2 = this.members.find(m => m.id === person2Id);
        if (!person1 || !person2) {
          resultContainer.innerHTML = '<div class="alert alert-danger">Error finding selected people</div>';
          return;
        }
        const directRelationship = this.getDirectRelationship(person1Id, person2Id);
        if (directRelationship) {
          resultContainer.innerHTML = `
            <div class="alert alert-success">
              <h5 class="alert-heading">Direct Relationship Found!</h5>
              <p>${this.getDisplayName(person1)} is ${directRelationship} of ${this.getDisplayName(person2)}</p>
            </div>
          `;
          return;
        }
        if (this.areSiblings(person1Id, person2Id)) {
          const siblingType = this.getSiblingType(person1Id, person2Id);
          resultContainer.innerHTML = `
            <div class="alert alert-success">
              <h5 class="alert-heading">Sibling Relationship Found!</h5>
              <p>${this.getDisplayName(person1)} is ${siblingType || ''} sibling of ${this.getDisplayName(person2)}</p>
            </div>
          `;
          return;
        }
        if (this.isGrandparent(person1Id, person2Id)) {
          resultContainer.innerHTML = `
            <div class="alert alert-success">
              <h5 class="alert-heading">Grandparent Relationship Found!</h5>
              <p>${this.getDisplayName(person1)} is a grandparent of ${this.getDisplayName(person2)}</p>
            </div>
          `;
          return;
        }
        if (this.isGrandparent(person2Id, person1Id)) {
          resultContainer.innerHTML = `
            <div class="alert alert-success">
              <h5 class="alert-heading">Grandparent Relationship Found!</h5>
              <p>${this.getDisplayName(person2)} is a grandparent of ${this.getDisplayName(person1)}</p>
            </div>
          `;
          return;
        }
        const cousinResult = this.findCousinRelationship(person1Id, person2Id);
        if (cousinResult) {
          resultContainer.innerHTML = `
            <div class="alert alert-success">
              <h5 class="alert-heading">Cousin Relationship Found!</h5>
              <p>${cousinResult}</p>
            </div>
          `;
          return;
        }
        const inLawRelationship = this.findInLawRelationship(person1Id, person2Id);
        if (inLawRelationship) {
          resultContainer.innerHTML = `
            <div class="alert alert-success">
              <h5 class="alert-heading">In-Law Relationship Found!</h5>
              <p>${inLawRelationship}</p>
            </div>
          `;
          return;
        }
        resultContainer.innerHTML = `
          <div class="alert alert-info">
            <h5 class="alert-heading">No Clear Relationship Found</h5>
            <p>No direct family relationship was found between ${this.getDisplayName(person1)} and ${this.getDisplayName(person2)}</p>
          </div>
        `;
      },
      
      // Get direct relationship between two people
      getDirectRelationship: function(person1Id, person2Id) {
        const isParent = this.relationships.some(r => r.from === person1Id && r.to === person2Id && r.type === 'parent');
        if (isParent) return 'a parent';
        const isChild = this.relationships.some(r => r.from === person2Id && r.to === person1Id && r.type === 'parent');
        if (isChild) return 'a child';
        const isSpouse = this.relationships.some(r => ((r.from === person1Id && r.to === person2Id) || (r.from === person2Id && r.to === person1Id)) && r.type === 'spouse');
        if (isSpouse) {
          const relationship = this.relationships.find(r => ((r.from === person1Id && r.to === person2Id) || (r.from === person2Id && r.to === person1Id)) && r.type === 'spouse');
          if (relationship && relationship.relationshipType) {
            switch (relationship.relationshipType) {
              case 'married': return 'married to';
              case 'divorced': return 'divorced from';
              case 'partner': return 'a partner of';
              case 'separated': return 'separated from';
              default: return 'a spouse of';
            }
          }
          return 'a spouse of';
        }
        return null;
      },
      
      // Check if two people are siblings
      areSiblings: function(person1Id, person2Id) {
        const directSibling = this.relationships.some(r => ((r.from === person1Id && r.to === person2Id) || (r.from === person2Id && r.to === person1Id)) && r.type === 'sibling');
        if (directSibling) return true;
        const parents1 = this.getParents(person1Id).map(p => p.id);
        const parents2 = this.getParents(person2Id).map(p => p.id);
        return parents1.some(p => parents2.includes(p));
      },
      
      // Get sibling type
      getSiblingType: function(person1Id, person2Id) {
        const siblingRel = this.relationships.find(r => ((r.from === person1Id && r.to === person2Id) || (r.from === person2Id && r.to === person1Id)) && r.type === 'sibling');
        if (siblingRel && siblingRel.relationshipType) return siblingRel.relationshipType;
        const parents1 = this.getParents(person1Id);
        const parents2 = this.getParents(person2Id);
        const parentIds1 = parents1.map(p => p.id);
        const parentIds2 = parents2.map(p => p.id);
        const commonParents = parentIds1.filter(id => parentIds2.includes(id));
        if (commonParents.length === 0) return null;
        return (parents1.length === parents2.length && commonParents.length === parents1.length) ? 'full' : 'half';
      },
      
      // Check if person1 is a grandparent of person2
      isGrandparent: function(person1Id, person2Id) {
        const children = this.getChildren(person1Id).map(c => c.id);
        const parents = this.getParents(person2Id).map(p => p.id);
        return children.some(childId => parents.includes(childId));
      },
      
      // Find cousin relationship
      findCousinRelationship: function(person1Id, person2Id) {
        const parents1 = this.getParents(person1Id);
        const parents2 = this.getParents(person2Id);
        for (const parent1 of parents1) {
          for (const parent2 of parents2) {
            if (this.areSiblings(parent1.id, parent2.id)) {
              return `${this.getDisplayName(person1)} and ${this.getDisplayName(person2)} are first cousins`;
            }
          }
        }
        return null;
      },
      
      // Find in-law relationships
      findInLawRelationship: function(person1Id, person2Id) {
        const spouses1 = this.getSpouses(person1Id);
        const spouses2 = this.getSpouses(person2Id);
        for (const spouse of spouses1) {
          if (this.getParents(spouse.id).map(p => p.id).includes(person2Id)) {
            return `${this.getDisplayName(person2)} is a parent-in-law of ${this.getDisplayName(person1)}`;
          }
        }
        for (const spouse of spouses2) {
          if (this.getParents(spouse.id).map(p => p.id).includes(person1Id)) {
            return `${this.getDisplayName(person1)} is a parent-in-law of ${this.getDisplayName(person2)}`;
          }
        }
        for (const spouse of spouses1) {
          if (this.areSiblings(spouse.id, person2Id)) {
            return `${this.getDisplayName(person2)} is a sibling-in-law of ${this.getDisplayName(person1)}`;
          }
        }
        for (const spouse of spouses2) {
          if (this.areSiblings(spouse.id, person1Id)) {
            return `${this.getDisplayName(person1)} is a sibling-in-law of ${this.getDisplayName(person2)}`;
          }
        }
        return null;
      },
      
      // Build tree data
      buildTreeData: function() {
        if (this.members.length === 0) return [];
        const processedMembers = new Set();
        let rootMembers = this.findRootMembers();
        const treeUnits = [];
        rootMembers.forEach(rootMember => {
          if (processedMembers.has(rootMember.id)) return;
          processedMembers.add(rootMember.id);
          const spouses = this.getSpouses(rootMember.id);
          if (spouses.length === 0) {
            const familyUnit = {
              id: `unit_${rootMember.id}`,
              parents: [rootMember],
              children: this.buildChildrenUnits(rootMember.id, null, processedMembers)
            };
            treeUnits.push(familyUnit);
          } else {
            spouses.forEach(spouse => {
              if (processedMembers.has(spouse.id)) return;
              processedMembers.add(spouse.id);
              const familyUnit = {
                id: `unit_${rootMember.id}_${spouse.id}`,
                parents: [rootMember, spouse],
                children: this.buildChildrenUnits(rootMember.id, spouse.id, processedMembers)
              };
              treeUnits.push(familyUnit);
            });
          }
        });
        return treeUnits;
      },
      
      // Find root members
      findRootMembers: function() {
        let rootMembers = this.members.filter(member => !this.relationships.some(r => r.to === member.id && r.type === 'parent'));
        if (rootMembers.length === 0 && this.members.length > 0) {
          const sortedMembers = [...this.members].sort((a, b) => {
            const yearA = a.birthYear ? parseInt(a.birthYear) : 9999;
            const yearB = b.birthYear ? parseInt(b.birthYear) : 9999;
            return yearA - yearB;
          });
          const numRoots = Math.max(1, Math.ceil(sortedMembers.length * 0.05));
          rootMembers = sortedMembers.slice(0, numRoots);
        }
        return rootMembers;
      },
      
      // Build children units
      buildChildrenUnits: function(parent1Id, parent2Id, processedMembers) {
        let childrenIds;
        if (parent2Id) {
          const children1 = this.relationships.filter(r => r.from === parent1Id && r.type === 'parent').map(r => r.to);
          const children2 = this.relationships.filter(r => r.from === parent2Id && r.type === 'parent').map(r => r.to);
          childrenIds = children1.filter(id => children2.includes(id));
          if (childrenIds.length === 0) {
            childrenIds = children1;
          }
        } else {
          childrenIds = this.relationships.filter(r => r.from === parent1Id && r.type === 'parent').map(r => r.to);
        }
        if (childrenIds.length === 0) return [];
        const childrenUnits = [];
        childrenIds.forEach(childId => {
          if (processedMembers.has(childId)) return;
          processedMembers.add(childId);
          const child = this.members.find(m => m.id === childId);
          if (!child) return;
          const spouses = this.getSpouses(childId);
          if (spouses.length === 0) {
            const childUnit = {
              id: `unit_${childId}`,
              parents: [child],
              children: this.buildChildrenUnits(childId, null, processedMembers)
            };
            childrenUnits.push(childUnit);
          } else {
            spouses.forEach(spouse => {
              if (processedMembers.has(spouse.id)) return;
              processedMembers.add(spouse.id);
              const childUnit = {
                id: `unit_${childId}_${spouse.id}`,
                parents: [child, spouse],
                children: this.buildChildrenUnits(childId, spouse.id, processedMembers)
              };
              childrenUnits.push(childUnit);
            });
          }
        });
        return childrenUnits;
      },
      
      // Layout family tree
      layoutFamilyTree: function(units, level, startX, startY, boxWidth, boxHeight, levelHeight, siblingDistance) {
        if (!units || units.length === 0) return [];
        const spacedUnits = [];
        let totalWidth = units.length * (boxWidth + siblingDistance);
        let currentX = startX - (totalWidth / 2) + (boxWidth / 2);
        units.forEach(unit => {
          let childPositions = [];
          if (unit.children && unit.children.length > 0) {
            childPositions = this.layoutFamilyTree(unit.children, level + 1, currentX + (boxWidth + siblingDistance) / 2, startY, boxWidth, boxHeight, levelHeight, siblingDistance);
          }
          let unitX = currentX;
          if (childPositions.length > 0) {
            const leftChild = childPositions[0];
            const rightChild = childPositions[childPositions.length - 1];
            unitX = (leftChild.x + rightChild.x) / 2;
          }
          const positionedUnit = {
            ...unit,
            x: unitX,
            y: startY + level * levelHeight,
            level: level,
            children: childPositions,
            width: unit.parents.length > 1 ? (boxWidth * 2 + 40) : boxWidth
          };
          spacedUnits.push(positionedUnit);
          currentX += boxWidth + siblingDistance;
        });
        
        // Adjust units to prevent overlap
        for (let i = 1; i < spacedUnits.length; i++) {
          const prevUnit = spacedUnits[i - 1];
          const currUnit = spacedUnits[i];
          const prevWidth = prevUnit.width || boxWidth;
          const currWidth = currUnit.width || boxWidth;
          const minDistance = (prevWidth / 2) + (currWidth / 2) + siblingDistance;
          if (currUnit.x - prevUnit.x < minDistance) {
            const shift = minDistance - (currUnit.x - prevUnit.x);
            currUnit.x += shift;
            for (let j = i + 1; j < spacedUnits.length; j++) {
              spacedUnits[j].x += shift;
            }
            if (currUnit.children && currUnit.children.length > 0) {
              this.shiftChildrenUnits(currUnit.children, shift);
            }
          }
        }
        return spacedUnits;
      },
      
      // Shift children units
      shiftChildrenUnits: function(units, shiftAmount) {
        if (!units || units.length === 0) return;
        units.forEach(unit => {
          unit.x += shiftAmount;
          if (unit.children && unit.children.length > 0) {
            this.shiftChildrenUnits(unit.children, shiftAmount);
          }
        });
      },
      
      // Draw family units
      drawFamilyUnits: function(svg, units, boxWidth, boxHeight) {
        if (!units || units.length === 0) return;
        units.forEach(unit => {
          this.drawFamilyUnit(svg, unit, boxWidth, boxHeight);
          if (unit.children && unit.children.length > 0) {
            const lineStartY = unit.y + boxHeight;
            const lineEndY = unit.children[0].y - 20;
            let centerX = unit.x;
            if (unit.parents.length > 1) {
              centerX = unit.x;
            } else {
              centerX = unit.x;
            }
            svg.append('path')
              .attr('class', 'tree-link')
              .attr('d', `M${centerX},${lineStartY} V${lineEndY}`);
            if (unit.children.length > 1) {
              const leftMostChild = unit.children[0];
              const rightMostChild = unit.children[unit.children.length - 1];
              svg.append('path')
                .attr('class', 'tree-link')
                .attr('d', `M${leftMostChild.x},${lineEndY} H${rightMostChild.x}`);
            }
            unit.children.forEach(child => {
              svg.append('path')
                .attr('class', 'tree-link')
                .attr('d', `M${child.x},${lineEndY} V${child.y}`);
            });
            this.drawFamilyUnits(svg, unit.children, boxWidth, boxHeight);
          }
        });
      },
      
      // Draw a family unit
      drawFamilyUnit: function(svg, unit, boxWidth, boxHeight) {
        const parents = unit.parents;
        if (parents.length === 0) return;
        const familyGroup = svg.append('g')
          .attr('class', 'family-unit')
          .attr('transform', `translate(${unit.x},${unit.y})`);
        if (parents.length === 1) {
          const parent = parents[0];
          this.drawPersonNode(familyGroup, parent, 0, 0, boxWidth, boxHeight);
        } else if (parents.length === 2) {
          const spacing = 40;
          const totalWidth = boxWidth * 2 + spacing;
          this.drawPersonNode(familyGroup, parents[0], -boxWidth - spacing / 2, 0, boxWidth, boxHeight);
          this.drawPersonNode(familyGroup, parents[1], spacing / 2, 0, boxWidth, boxHeight);
          familyGroup.append('path')
            .attr('class', 'marriage-link')
            .attr('d', `M${-spacing / 2},${boxHeight / 2} H${spacing / 2}`);
        }
      },
      
      // Draw a person node
      drawPersonNode: function(group, person, x, y, width, height) {
        const nodeGroup = group.append('g')
          .attr('class', 'family-node')
          .attr('transform', `translate(${x},${y})`)
          .attr('data-id', person.id)
          .style('cursor', 'pointer')
          .on('click', (event) => {
            const id = event.currentTarget.getAttribute('data-id');
            const member = this.members.find(m => m.id === id);
            if (member) {
              this.showProfile(member);
            }
          });
        
        let nodeShape;
        if (person.gender === 'male') {
          nodeGroup.append('rect')
            .attr('width', width)
            .attr('height', height)
            .attr('rx', 5)
            .attr('fill', 'white')
            .attr('stroke', '#4A89DC')
            .attr('stroke-width', 1);
          nodeShape = nodeGroup.append('rect')
            .attr('class', 'node-male')
            .attr('width', width)
            .attr('height', height)
            .attr('rx', 5)
            .attr('fill-opacity', 0.8);
        } else if (person.gender === 'female') {
          nodeGroup.append('ellipse')
            .attr('cx', width / 2)
            .attr('cy', height / 2)
            .attr('rx', width / 2)
            .attr('ry', height / 2)
            .attr('fill', 'white')
            .attr('stroke', '#D770AD')
            .attr('stroke-width', 1);
          nodeShape = nodeGroup.append('ellipse')
            .attr('class', 'node-female')
            .attr('cx', width / 2)
            .attr('cy', height / 2)
            .attr('rx', width / 2)
            .attr('ry', height / 2)
            .attr('fill-opacity', 0.8);
        } else {
          nodeGroup.append('polygon')
            .attr('points', `${width/2},0 ${width},${height/2} ${width/2},${height} 0,${height/2}`)
            .attr('fill', 'white')
            .attr('stroke', '#656D78')
            .attr('stroke-width', 1);
          nodeShape = nodeGroup.append('polygon')
            .attr('class', 'node-unknown')
            .attr('points', `${width/2},0 ${width},${height/2} ${width/2},${height} 0,${height/2}`)
            .attr('fill-opacity', 0.8);
        }
        
        if (person.photo) {
          const clipId = `clip-${person.id}`;
          const defs = group.append('defs');
          const clipPath = defs.append('clipPath').attr('id', clipId);
          if (person.gender === 'male') {
            clipPath.append('rect')
              .attr('x', width/2 - 25)
              .attr('y', -30)
              .attr('width', 50)
              .attr('height', 50)
              .attr('rx', 5);
          } else {
            clipPath.append('circle')
              .attr('cx', width/2)
              .attr('cy', -15)
              .attr('r', 25);
          }
          nodeGroup.append('rect')
            .attr('x', width/2 - 28)
            .attr('y', -33)
            .attr('width', 56)
            .attr('height', 56)
            .attr('rx', 28)
            .attr('fill', 'white')
            .attr('stroke', '#ccc')
            .attr('stroke-width', 2);
          nodeGroup.append('image')
            .attr('x', width/2 - 25)
            .attr('y', -30)
            .attr('width', 50)
            .attr('height', 50)
            .attr('clip-path', `url(#${clipId})`)
            .attr('xlink:href', person.photo);
        }
        
        nodeGroup.append('text')
          .attr('x', width / 2)
          .attr('y', height / 2 + 5)
          .attr('text-anchor', 'middle')
          .attr('fill', 'black')
          .attr('font-weight', 'bold')
          .attr('font-size', '14px')
          .text(this.getShortName(person));
        
        if (person.birthMonth || person.birthDay || person.birthYear) {
          let dateText = this.formatDateString(person.birthMonth, person.birthDay, person.birthYear);
          if (person.deathMonth || person.deathDay || person.deathYear) {
            dateText += " - " + this.formatDateString(person.deathMonth, person.deathDay, person.deathYear);
          }
          nodeGroup.append('text')
            .attr('class', 'node-year-label')
            .attr('x', width / 2)
            .attr('y', height + 24)
            .attr('fill', '#00008B')  /* Changed to dark blue */
            .attr('font-weight', 'normal')
            .attr('font-size', '12px')
            .attr('text-anchor', 'middle')
            .text(dateText);
        }
        
        const deleteBtn = nodeGroup.append('g')
          .attr('class', 'delete-button')
          .attr('transform', `translate(${width - 5}, 0)`)
          .style('cursor', 'pointer')
          .on('click', (event) => {
            event.stopPropagation();
            const id = nodeGroup.attr('data-id');
            if (confirm('Are you sure you want to delete this person?')) {
              this.deleteMember(id);
            }
          });
        
        deleteBtn.append('circle')
          .attr('cx', 0)
          .attr('cy', 0)
          .attr('r', 10)
          .attr('fill', 'white')
          .attr('stroke', '#e74c3c')
          .attr('stroke-width', 1);
        
        deleteBtn.append('text')
          .attr('x', 0)
          .attr('y', 4)
          .attr('text-anchor', 'middle')
          .attr('fill', '#e74c3c')
          .attr('font-weight', 'bold')
          .text('');
      },
      
      // Delete a family member
      deleteMember: function(memberId) {
        const memberIndex = this.members.findIndex(m => m.id === memberId);
        if (memberIndex === -1) return;
        this.members.splice(memberIndex, 1);
        this.relationships = this.relationships.filter(r => r.from !== memberId && r.to !== memberId);
        this.saveData();
        this.populateMemberSelectors();
        this.renderTree();
      },
      
      // Utility functions
      getDisplayName: function(member) {
        if (!member) return 'Unknown';
        let name = member.firstName || '';
        if (member.middleName) name += ' ' + member.middleName;
        if (member.lastName) name += ' ' + member.lastName;
        return name.trim() || 'Unnamed';
      },
      
      getShortName: function(member) {
        return member.firstName || (member.lastName || 'Unnamed');
      },
      
      capitalizeFirst: function(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      },
      
      generateUniqueId: function() {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
      },
      
      // Render the family tree visualization
      renderTree: function(forceReorganize = false) {
        const container = document.getElementById('tree-container');
        container.innerHTML = '';
        if (this.members.length === 0) {
          container.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center h-100">
              <h3 class="text-muted mb-4">No family members yet</h3>
              <button id="start-adding-button" class="btn btn-primary">Add Your First Family Member</button>
            </div>
          `;
          document.getElementById('start-adding-button').addEventListener('click', () => {
            this.resetForm();
            this.showPage('form');
          });
          return;
        }
        
        const width = container.clientWidth;
        const height = container.clientHeight;
        const boxWidth = 120;
        const boxHeight = 40;
        const levelHeight = 120;
        const siblingDistance = 40; // Increased spacing to avoid overlapping
        
        const svg = d3.select(container)
          .append('svg')
          .attr('width', width)
          .attr('height', height);
        
        const zoom = d3.zoom()
          .scaleExtent([0.1, 3])
          .on('zoom', (event) => {
            g.attr('transform', event.transform);
          });
        
        svg.call(zoom);
        
        const g = svg.append('g');
        
        this.processedMemberIds = new Set();
        
        const treeData = this.buildTreeData();
        
        if (!treeData || treeData.length === 0) {
          container.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center h-100">
              <h3 class="text-muted mb-4">Could not create family tree structure</h3>
              <p class="text-center">Try adding more family members with clear parent-child relationships.</p>
            </div>
          `;
          return;
        }
        
        const rootUnits = this.layoutFamilyTree(treeData, 0, width / 2, 0, boxWidth, boxHeight, levelHeight, siblingDistance);
        
        this.drawFamilyUnits(g, rootUnits, boxWidth, boxHeight);
        
        const bounds = g.node().getBBox();
        const centerX = bounds.x + bounds.width / 2;
        const centerY = bounds.y + bounds.height / 2;
        const scale = 0.9 / Math.max(bounds.width / width, bounds.height / height);
        const translate = [width / 2 - scale * centerX, height / 2 - scale * centerY];
        this.zoomLevel = scale;
        svg.call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
      }
    };
    
    document.addEventListener('DOMContentLoaded', function() {
      familyTreeApp.init();
      document.querySelectorAll('button').forEach(button => {
        const id = button.id;
        switch(id) {
          case 'start-button':
            button.onclick = () => familyTreeApp.showPage('form');
            break;
          case 'import-button':
            button.onclick = () => document.getElementById('import-file').click();
            break;
          case 'back-to-tree-from-form':
            button.onclick = () => familyTreeApp.showPage(familyTreeApp.members.length > 0 ? 'tree' : 'welcome');
            break;
          case 'cancel-button':
            button.onclick = () => familyTreeApp.showPage(familyTreeApp.members.length > 0 ? 'tree' : 'welcome');
            break;
          case 'reset-button':
            button.onclick = () => familyTreeApp.resetForm();
            break;
          case 'save-button':
            button.onclick = () => familyTreeApp.saveMember();
            break;
          case 'add-member-button':
            button.onclick = () => {
              familyTreeApp.resetForm();
              familyTreeApp.showPage('form');
            };
            break;
          case 'add-member-floating':
            button.onclick = () => {
              familyTreeApp.resetForm();
              familyTreeApp.showPage('form');
            };
            break;
          case 'export-button':
            button.onclick = () => familyTreeApp.exportData();
            break;
          case 'back-to-tree-button':
            button.onclick = () => familyTreeApp.showPage('tree');
            break;
          case 'organize-tree-button':
            button.onclick = () => familyTreeApp.renderTree(true);
            break;
          case 'zoom-in-button':
            button.onclick = () => familyTreeApp.zoomTree(0.2);
            break;
          case 'zoom-out-button':
            button.onclick = () => familyTreeApp.zoomTree(-0.2);
            break;
          case 'center-tree-button':
            button.onclick = () => familyTreeApp.centerTree();
            break;
          case 'toggle-relationship-finder':
            button.onclick = () => {
              const finderPanel = document.getElementById('relationship-finder');
              finderPanel.style.display = finderPanel.style.display === 'none' ? 'block' : 'none';
              if (finderPanel.style.display === 'block') familyTreeApp.populateRelationshipFinderSelects();
            };
            break;
          case 'close-relationship-finder':
            button.onclick = () => {
              document.getElementById('relationship-finder').style.display = 'none';
            };
            break;
          case 'find-relationship-btn':
            button.onclick = () => familyTreeApp.findRelationship();
            break;
        }
      });
    });
  </script>
</body>
</html>
